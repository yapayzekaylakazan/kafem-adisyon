<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Adisyo â€” Kafe Adisyon Sistemi</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  :root {
    --bg: #1a1205; --surface: #241a08; --surface2: #2e2210; --surface3: #3a2c18;
    --accent: #d4960e; --accent2: #f0b830; --text: #fff8ee; --text2: #c8a870;
    --muted: #7a6040; --success: #3db85a; --danger: #e04040;
    --border: rgba(212,150,14,0.2); --radius: 14px;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
  html, body { height: 100%; overflow: hidden; }
  body { font-family: 'Nunito', sans-serif; background: var(--bg); color: var(--text); display: flex; flex-direction: column; }

  /* â”€â”€ GÄ°RÄ°Å EKRANI â”€â”€ */
  #auth-screen {
    position: fixed; inset: 0; background: var(--bg); z-index: 999;
    display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px;
  }
  .auth-logo { font-size: 3rem; margin-bottom: 6px; }
  .auth-title { font-size: 2rem; font-weight: 900; color: var(--accent2); margin-bottom: 4px; }
  .auth-sub { font-size: 0.85rem; color: var(--muted); margin-bottom: 32px; font-weight: 600; }
  .auth-card { background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 24px; width: 100%; max-width: 380px; }
  .auth-tabs { display: flex; gap: 0; margin-bottom: 20px; background: var(--surface2); border-radius: 12px; padding: 4px; }
  .auth-tab { flex: 1; padding: 10px; border: none; background: none; color: var(--muted); font-family: 'Nunito', sans-serif; font-size: 0.9rem; font-weight: 800; cursor: pointer; border-radius: 10px; transition: all 0.2s; }
  .auth-tab.active { background: var(--accent); color: var(--bg); }
  .auth-inp { width: 100%; background: var(--surface2); border: 1.5px solid var(--border); border-radius: 12px; padding: 13px 14px; color: var(--text); font-family: 'Nunito', sans-serif; font-size: 1rem; font-weight: 600; outline: none; margin-bottom: 10px; }
  .auth-inp:focus { border-color: var(--accent); }
  .auth-inp::placeholder { color: var(--muted); }
  .auth-btn { width: 100%; padding: 14px; border-radius: 12px; border: none; background: var(--accent); color: var(--bg); font-family: 'Nunito', sans-serif; font-size: 1rem; font-weight: 900; cursor: pointer; margin-top: 4px; }
  .auth-btn:active { filter: brightness(0.9); }
  .auth-err { color: var(--danger); font-size: 0.8rem; font-weight: 700; margin-bottom: 8px; text-align: center; display: none; }
  .auth-loading { text-align: center; color: var(--muted); font-size: 0.85rem; font-weight: 700; padding: 8px; display: none; }

  /* â”€â”€ HEADER â”€â”€ */
  .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 10px 14px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
  .header-left { display: flex; align-items: center; gap: 8px; }
  .header h1 { font-size: 1.2rem; font-weight: 900; color: var(--accent2); }
  .header-kafe { font-size: 0.7rem; color: var(--muted); font-weight: 700; }
  .header-stats { display: flex; gap: 8px; align-items: center; }
  .hstat { font-size: 0.72rem; color: var(--text2); font-weight: 700; }
  .hstat span { color: var(--accent2); }
  .cikis-btn { background: none; border: 1px solid var(--border); border-radius: 8px; color: var(--muted); font-family: 'Nunito', sans-serif; font-size: 0.7rem; font-weight: 700; padding: 4px 8px; cursor: pointer; }

  /* â”€â”€ BOTTOM NAV â”€â”€ */
  .bottom-nav { display: flex; background: var(--surface); border-top: 1px solid var(--border); flex-shrink: 0; }
  .bnav-btn { flex: 1; padding: 10px 4px; background: none; border: none; color: var(--muted); font-family: 'Nunito', sans-serif; font-size: 0.68rem; font-weight: 700; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 2px; position: relative; }
  .bnav-btn .nav-icon { font-size: 1.2rem; line-height: 1; }
  .bnav-btn.active { color: var(--accent2); }
  .bnav-btn.active::after { content: ''; position: absolute; bottom: 0; left: 20%; right: 20%; height: 3px; background: var(--accent2); border-radius: 3px 3px 0 0; }

  /* â”€â”€ PAGES â”€â”€ */
  .page { display: none; flex: 1; overflow: hidden; flex-direction: column; min-height: 0; }
  .page.active { display: flex; }
  .page-masalar { overflow-y: auto; padding: 12px; }
  .page-title { font-size: 0.95rem; font-weight: 800; color: var(--text2); margin-bottom: 10px; }

  /* â”€â”€ MASALAR â”€â”€ */
  .masalar-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 9px; }
  .masa-kart { aspect-ratio: 1; border-radius: var(--radius); border: 2px solid var(--border); background: var(--surface2); cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 1px; transition: all 0.18s; position: relative; user-select: none; }
  .masa-kart:active { transform: scale(0.94); }
  .masa-kart.secili { border-color: var(--accent2); background: var(--surface3); box-shadow: 0 0 14px rgba(240,184,48,0.3); }
  .masa-kart.dolu { border-color: var(--accent); }
  .masa-kart .mn { font-size: 1.3rem; font-weight: 900; color: var(--accent2); line-height: 1; }
  .masa-kart .mad { font-size: 0.65rem; font-weight: 900; color: var(--text); text-align: center; max-width: 68px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
  .masa-kart .mt { font-size: 0.62rem; color: var(--success); font-weight: 800; }
  .masa-kart .mgarson { font-size: 0.52rem; color: var(--accent); font-weight: 700; }
  .masa-kart .mb { position: absolute; top: 4px; right: 4px; background: var(--accent); color: var(--bg); border-radius: 50%; width: 16px; height: 16px; font-size: 0.55rem; font-weight: 900; display: flex; align-items: center; justify-content: center; }
  .masa-not-btn { position: absolute; bottom: 3px; right: 3px; background: none; border: none; font-size: 0.65rem; color: var(--muted); cursor: pointer; padding: 2px; }

  /* â”€â”€ ADÄ°SYON â”€â”€ */
  .page-adisyon { flex-direction: column; overflow: hidden; display: flex; min-height: 0; }
  .adisyon-masa-header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 8px 12px; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; gap: 6px; }
  .amh-left { display: flex; flex-direction: column; gap: 3px; min-width: 0; }
  .amh-title { font-size: 1rem; font-weight: 900; color: var(--accent2); }
  .amh-chips { display: flex; gap: 5px; align-items: center; flex-wrap: wrap; }
  .garson-chip { background: var(--surface3); border: 1px solid var(--border); border-radius: 20px; padding: 2px 8px; font-size: 0.68rem; font-weight: 700; color: var(--accent2); cursor: pointer; white-space: nowrap; }
  .indirim-chip { display: inline-block; background: var(--danger); color: #fff; font-size: 0.65rem; font-weight: 800; border-radius: 6px; padding: 1px 5px; }
  .amh-actions { display: flex; gap: 4px; flex-wrap: wrap; justify-content: flex-end; }
  .amh-btn { padding: 6px 9px; border-radius: 9px; border: 1px solid var(--border); background: var(--surface2); color: var(--text); font-family: 'Nunito', sans-serif; font-size: 0.7rem; font-weight: 700; cursor: pointer; white-space: nowrap; }
  .amh-btn:active { transform: scale(0.95); }
  .adisyon-body { flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
  .urun-bolumu { flex: 0 0 52%; display: flex; flex-direction: column; overflow: hidden; border-bottom: 2px solid var(--border); min-height: 0; }
  .cat-tabs { display: flex; gap: 6px; padding: 8px 10px 6px; overflow-x: auto; flex-shrink: 0; }
  .cat-tabs::-webkit-scrollbar { height: 0; }
  .cat-tab { padding: 6px 12px; border-radius: 20px; border: 1.5px solid var(--border); background: var(--surface2); color: var(--text2); font-family: 'Nunito', sans-serif; font-size: 0.75rem; font-weight: 700; cursor: pointer; white-space: nowrap; }
  .cat-tab.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
  .urun-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 7px; padding: 6px 10px; overflow-y: auto; flex: 1; align-content: start; }
  .urun-kart { background: var(--surface2); border: 1.5px solid var(--border); border-radius: var(--radius); padding: 10px 5px; cursor: pointer; text-align: center; transition: all 0.15s; position: relative; user-select: none; }
  .urun-kart:active { transform: scale(0.93); background: var(--surface3); }
  .urun-kart .ui { font-size: 1.6rem; margin-bottom: 3px; }
  .urun-kart .un { font-size: 0.72rem; font-weight: 700; line-height: 1.2; margin-bottom: 2px; }
  .urun-kart .up { font-size: 0.8rem; font-weight: 900; color: var(--accent2); }
  .urun-kart .udel { position: absolute; top: 3px; right: 3px; background: none; border: none; color: var(--muted); font-size: 0.7rem; cursor: pointer; padding: 2px; opacity: 0.5; }
  .siparis-bolumu { background: var(--surface); flex: 1; display: flex; flex-direction: column; overflow: hidden; min-height: 0; }
  .siparis-baslik { padding: 6px 12px 3px; font-size: 0.72rem; font-weight: 800; color: var(--text2); letter-spacing: 1px; text-transform: uppercase; flex-shrink: 0; }
  .siparis-liste { overflow-y: auto; flex: 1; padding: 0 8px; }
  .siparis-item { display: flex; align-items: center; gap: 6px; padding: 8px 6px; border-bottom: 1px solid var(--border); }
  .si-isim { flex: 1; font-size: 0.88rem; font-weight: 700; }
  .si-miktar { display: flex; align-items: center; gap: 4px; }
  .si-btn { width: 26px; height: 26px; border-radius: 7px; border: 1.5px solid var(--border); background: var(--surface2); color: var(--text); font-size: 0.9rem; font-weight: 700; display: flex; align-items: center; justify-content: center; cursor: pointer; }
  .si-btn:active { background: var(--accent); color: var(--bg); }
  .si-sayi { font-size: 0.95rem; font-weight: 900; color: var(--accent2); min-width: 20px; text-align: center; }
  .si-fiyat { font-size: 0.85rem; font-weight: 800; color: var(--text2); min-width: 56px; text-align: right; }
  .si-sil { background: none; border: none; color: var(--muted); font-size: 0.9rem; cursor: pointer; }
  .adisyon-footer { padding: 8px 12px; background: var(--surface); border-top: 1px solid var(--border); flex-shrink: 0; display: flex; align-items: center; gap: 8px; }
  .toplam-alan { flex: 1; }
  .toplam-etiket { font-size: 0.68rem; color: var(--muted); font-weight: 700; }
  .toplam-onceki { font-size: 0.72rem; color: var(--muted); text-decoration: line-through; display: none; }
  .toplam-tutar { font-size: 1.5rem; font-weight: 900; color: var(--accent2); line-height: 1.1; }
  .odeme-butonlar { display: flex; flex-direction: column; gap: 5px; }
  .btn-nakit { padding: 11px 16px; border-radius: 11px; border: none; background: var(--success); color: #fff; font-family: 'Nunito', sans-serif; font-size: 0.85rem; font-weight: 900; cursor: pointer; white-space: nowrap; }
  .btn-bol { padding: 7px 12px; border-radius: 11px; border: 1.5px solid var(--border); background: var(--surface2); color: var(--text); font-family: 'Nunito', sans-serif; font-size: 0.75rem; font-weight: 700; cursor: pointer; text-align: center; }
  .bos-durum { display: flex; flex-direction: column; align-items: center; justify-content: center; flex: 1; color: var(--muted); gap: 7px; padding: 16px; }
  .bos-durum .bi { font-size: 2rem; opacity: 0.3; }
  .masa-secilmedi { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: var(--muted); gap: 8px; padding: 24px; text-align: center; }
  .masa-secilmedi .msi { font-size: 2.5rem; opacity: 0.2; }

  /* â”€â”€ ÃœRÃœN EKLE â”€â”€ */
  .page-urun { overflow-y: auto; padding: 12px; }
  .form-group { margin-bottom: 12px; }
  .form-group label { display: block; font-size: 0.78rem; font-weight: 700; color: var(--text2); margin-bottom: 5px; }
  .form-group input, .form-group select { width: 100%; background: var(--surface2); border: 1.5px solid var(--border); border-radius: 11px; padding: 12px 13px; color: var(--text); font-family: 'Nunito', sans-serif; font-size: 0.95rem; font-weight: 600; outline: none; }
  .form-group input:focus, .form-group select:focus { border-color: var(--accent); }
  .form-group input::placeholder { color: var(--muted); }
  .form-group select option { background: var(--surface2); }
  .btn-kaydet { width: 100%; padding: 14px; border-radius: 13px; border: none; background: var(--accent); color: var(--bg); font-family: 'Nunito', sans-serif; font-size: 0.95rem; font-weight: 900; cursor: pointer; margin-bottom: 8px; }
  .btn-yeni-kat { width: 100%; padding: 11px; border-radius: 13px; border: 1.5px solid var(--border); background: var(--surface2); color: var(--text2); font-family: 'Nunito', sans-serif; font-size: 0.85rem; font-weight: 700; cursor: pointer; margin-bottom: 18px; }
  .urun-listesi-baslik { font-size: 0.7rem; font-weight: 800; color: var(--muted); letter-spacing: 2px; text-transform: uppercase; margin-bottom: 8px; }
  .urun-listesi-item { display: flex; align-items: center; gap: 8px; background: var(--surface2); border: 1px solid var(--border); border-radius: 11px; padding: 10px 12px; margin-bottom: 7px; }
  .uli-icon { font-size: 1.2rem; }
  .uli-info { flex: 1; }
  .uli-isim { font-size: 0.85rem; font-weight: 700; }
  .uli-cat { font-size: 0.68rem; color: var(--muted); font-weight: 600; }
  .uli-fiyat-wrap { display: flex; align-items: center; gap: 2px; }
  .uli-fiyat-input { width: 58px; background: var(--surface3); border: 1.5px solid var(--border); border-radius: 7px; padding: 5px 7px; color: var(--accent2); font-family: 'Nunito', sans-serif; font-size: 0.85rem; font-weight: 900; text-align: center; outline: none; }
  .uli-fiyat-input:focus { border-color: var(--accent2); }
  .uli-tl { font-size: 0.8rem; font-weight: 800; color: var(--accent2); }
  .uli-sil { background: none; border: none; color: var(--muted); font-size: 1rem; cursor: pointer; padding: 3px; }

  /* â”€â”€ RAPOR â”€â”€ */
  .page-rapor { overflow-y: auto; padding: 12px; }
  .rapor-ozet { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
  .rapor-kart { background: var(--surface2); border: 1.5px solid var(--border); border-radius: var(--radius); padding: 12px 14px; }
  .rapor-kart .rk-label { font-size: 0.7rem; font-weight: 800; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 3px; }
  .rapor-kart .rk-val { font-size: 1.6rem; font-weight: 900; color: var(--accent2); }
  .rapor-tablo-baslik { display: flex; justify-content: space-between; font-size: 0.68rem; font-weight: 800; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; padding: 0 3px; margin-bottom: 7px; }
  .rapor-satir { display: flex; align-items: center; gap: 7px; background: var(--surface2); border-radius: 9px; padding: 10px 12px; margin-bottom: 6px; }
  .rs-isim { flex: 1; font-size: 0.85rem; font-weight: 700; }
  .rs-adet { font-size: 0.8rem; font-weight: 800; color: var(--text2); min-width: 38px; text-align: center; }
  .rs-tutar { font-size: 0.88rem; font-weight: 900; color: var(--accent2); min-width: 75px; text-align: right; }
  .bos-rapor { text-align: center; color: var(--muted); padding: 30px 16px; font-size: 0.85rem; font-weight: 700; }
  .donem-tab { padding: 7px 12px; border-radius: 20px; border: 1.5px solid var(--border); background: var(--surface2); color: var(--text2); font-family: 'Nunito', sans-serif; font-size: 0.75rem; font-weight: 800; cursor: pointer; }
  .donem-tab.active { background: var(--accent); color: var(--bg); border-color: var(--accent); }
  .fis-al-btn { width: 100%; padding: 7px; border-radius: 8px; border: 1.5px solid var(--border); background: var(--surface3); color: var(--text); font-family: 'Nunito', sans-serif; font-size: 0.72rem; font-weight: 800; cursor: pointer; }
  .fis-al-btn:active { background: var(--accent); color: var(--bg); }

  /* â”€â”€ AYARLAR â”€â”€ */
  .page-ayarlar { overflow-y: auto; padding: 12px; }
  .ayar-kart { background: var(--surface2); border: 1px solid var(--border); border-radius: var(--radius); padding: 14px 16px; margin-bottom: 10px; }
  .ayar-kart h3 { font-size: 0.8rem; font-weight: 800; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
  .ayar-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid var(--border); }
  .ayar-row:last-child { border-bottom: none; }
  .ayar-label { font-size: 0.88rem; font-weight: 700; }
  .ayar-val { font-size: 0.82rem; color: var(--muted); font-weight: 600; }
  .ayar-btn { padding: 6px 14px; border-radius: 9px; border: 1.5px solid var(--border); background: var(--surface3); color: var(--text); font-family: 'Nunito', sans-serif; font-size: 0.78rem; font-weight: 700; cursor: pointer; }
  .plan-badge { padding: 3px 10px; border-radius: 20px; font-size: 0.72rem; font-weight: 900; }
  .plan-ucretsiz { background: var(--surface3); color: var(--muted); }
  .plan-pro { background: var(--accent); color: var(--bg); }

  /* â”€â”€ MODAL â”€â”€ */
  .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.75); display: none; align-items: flex-end; justify-content: center; z-index: 200; }
  .modal-overlay.ac { display: flex; }
  .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 20px 20px 0 0; padding: 18px 16px 28px; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; animation: slideUp 0.22s ease; }
  @keyframes slideUp { from { transform: translateY(36px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
  .modal-baslik { font-size: 1.05rem; font-weight: 900; color: var(--accent2); margin-bottom: 14px; }
  .modal-kapat { width: 100%; margin-top: 10px; padding: 12px; border-radius: 11px; border: 1.5px solid var(--border); background: var(--surface2); color: var(--text); font-family: 'Nunito', sans-serif; font-size: 0.85rem; font-weight: 700; cursor: pointer; }
  .transfer-grid { display: grid; grid-template-columns: repeat(5,1fr); gap: 7px; margin-bottom: 12px; }
  .tr-btn { padding: 12px 4px; border-radius: 9px; border: 1.5px solid var(--border); background: var(--surface2); color: var(--text); font-family: 'Nunito', sans-serif; font-size: 0.9rem; font-weight: 800; cursor: pointer; text-align: center; }
  .tr-btn.dolu-t { border-color: var(--accent); color: var(--accent2); }
  .tr-btn:disabled { opacity: 0.25; cursor: not-allowed; }
  .split-item { display: flex; align-items: center; gap: 8px; background: var(--surface2); border: 1px solid var(--border); border-radius: 11px; padding: 11px 13px; margin-bottom: 7px; }
  .spi-isim { flex: 1; font-size: 0.9rem; font-weight: 700; }
  .spi-tutar { font-size: 0.95rem; font-weight: 900; color: var(--accent2); }
  .spi-tahsil { padding: 7px 12px; border-radius: 8px; border: 1.5px solid var(--border); background: var(--surface3); color: var(--text); font-family: 'Nunito', sans-serif; font-size: 0.75rem; font-weight: 700; cursor: pointer; }
  .spi-tahsil:active:not(:disabled) { background: var(--success); color: #fff; }
  .spi-tahsil:disabled { opacity: 0.4; }
  .spi-odendi { font-size: 0.8rem; font-weight: 700; color: var(--success); }
  .indirim-hizli-btn { padding: 11px 4px; border-radius: 9px; border: 1.5px solid var(--border); background: var(--surface2); color: var(--text); font-family: 'Nunito', sans-serif; font-size: 0.85rem; font-weight: 900; cursor: pointer; }
  .indirim-hizli-btn:active { background: var(--danger); color: #fff; }

  /* â”€â”€ FÄ°Å MODAL â”€â”€ */
  @media print {
    * { visibility: hidden !important; }
    #fis-yazdir-icerik, #fis-yazdir-icerik * { visibility: visible !important; }
    #fis-yazdir-icerik { position: fixed !important; top: 0; left: 0; width: 100%; background: #fff; padding: 20px; border-radius: 0; }
    .fis-disbutonlar { display: none !important; }
  }
  .fis-yazdir-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 500; align-items: center; justify-content: center; padding: 14px; }
  .fis-yazdir-modal.ac { display: flex; }
  #fis-yazdir-icerik { background: #fff; color: #000; border-radius: 11px; padding: 18px; width: 100%; max-width: 310px; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.7; }
  .fis-center { text-align: center; }
  .fis-line { border-top: 1px dashed #000; margin: 5px 0; }
  .fis-row { display: flex; justify-content: space-between; }
  .fis-btn-row { display: flex; gap: 7px; margin-top: 12px; }
  .fis-btn { flex: 1; padding: 11px; border-radius: 9px; border: none; font-family: 'Nunito', sans-serif; font-size: 0.85rem; font-weight: 800; cursor: pointer; }
  .fis-btn.baglan { background: #1a6fb5; color: #fff; }
  .fis-btn.yazdir { background: #222; color: #fff; }
  .fis-btn.kapat { background: #e04040; color: #fff; }

  /* â”€â”€ TOAST & LOADING â”€â”€ */
  .toast { position: fixed; bottom: 72px; left: 50%; transform: translateX(-50%) translateY(10px); background: var(--surface3); border: 1.5px solid var(--accent); color: var(--text); padding: 10px 18px; border-radius: 11px; font-size: 0.84rem; font-weight: 700; z-index: 300; opacity: 0; transition: all 0.22s; pointer-events: none; white-space: nowrap; max-width: 90vw; }
  .toast.goster { opacity: 1; transform: translateX(-50%) translateY(0); }
  .yukleniyor { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 400; display: none; }
  .yukleniyor-ic { background: var(--surface); border-radius: 16px; padding: 24px 32px; text-align: center; }
  .yukleniyor-ic p { color: var(--text2); font-weight: 700; margin-top: 8px; font-size: 0.9rem; }
  .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent2); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto; }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* sync gÃ¶stergesi */
  .sync-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success); display: inline-block; margin-left: 6px; }
  .sync-dot.offline { background: var(--danger); }
</style>
</head>
<body>

<!-- â”€â”€ GÄ°RÄ°Å EKRANI â”€â”€ -->
<div id="auth-screen">
  <div class="auth-logo">â˜•</div>
  <div class="auth-title">Adisyo</div>
  <div class="auth-sub">Kafe Adisyon Sistemi</div>
  <div class="auth-card">
    <div class="auth-tabs">
      <button class="auth-tab active" id="tab-giris" onclick="authTab('giris')">GiriÅŸ Yap</button>
      <button class="auth-tab" id="tab-kayit" onclick="authTab('kayit')">KayÄ±t Ol</button>
    </div>
    <div id="auth-err" class="auth-err"></div>
    <div id="auth-giris">
      <input class="auth-inp" id="giris-email" type="email" placeholder="E-posta" autocomplete="email">
      <input class="auth-inp" id="giris-sifre" type="password" placeholder="Åifre" autocomplete="current-password">
      <button class="auth-btn" onclick="girisYap()">GiriÅŸ Yap</button>
    </div>
    <div id="auth-kayit" style="display:none;">
      <input class="auth-inp" id="kayit-kafe" type="text" placeholder="Kafe AdÄ± (Ã¶rn: Kahve DuraÄŸÄ±)">
      <input class="auth-inp" id="kayit-email" type="email" placeholder="E-posta" autocomplete="email">
      <input class="auth-inp" id="kayit-sifre" type="password" placeholder="Åifre (min 6 karakter)" autocomplete="new-password">
      <button class="auth-btn" onclick="kayitOl()">Hesap OluÅŸtur</button>
    </div>
    <div id="auth-loading" class="auth-loading">â³ LÃ¼tfen bekleyin...</div>
  </div>
</div>

<!-- â”€â”€ ANA UYGULAMA â”€â”€ -->
<div id="app" style="display:none; flex:1; flex-direction:column; overflow:hidden; min-height:0; display:none;">

<div class="header">
  <div class="header-left">
    <div>
      <h1>â˜• Adisyo <span class="sync-dot" id="sync-dot"></span></h1>
      <div class="header-kafe" id="header-kafe-adi">YÃ¼kleniyor...</div>
    </div>
  </div>
  <div class="header-stats">
    <div class="hstat">Dolu: <span id="hstat-dolu">0</span>/20</div>
    <div class="hstat">Ciro: <span id="hstat-ciro">0â‚º</span></div>
    <button class="cikis-btn" onclick="cikisYap()">Ã‡Ä±kÄ±ÅŸ</button>
  </div>
</div>

<!-- PAGES -->
<div class="page active" id="page-masalar">
  <div class="page-masalar">
    <div class="page-title">ğŸª‘ Masalar</div>
    <div class="masalar-grid" id="masalar-grid"></div>
  </div>
</div>

<div class="page" id="page-adisyon">
  <div class="page-adisyon">
    <div class="masa-secilmedi" id="masa-secilmedi-msg">
      <div class="msi">â˜ï¸</div>
      <p>Ã–nce Masalar sekmesinden bir masa seÃ§in</p>
    </div>
    <div id="adisyon-icerik" style="display:none; flex:1; flex-direction:column; overflow:hidden; min-height:0;">
      <div class="adisyon-masa-header">
        <div class="amh-left">
          <div class="amh-title" id="adisyon-masa-basligi">Masa</div>
          <div class="amh-chips">
            <span class="garson-chip" id="garson-chip" onclick="garsonSec()">ğŸ‘¤ Garson</span>
            <span id="indirim-chip-goster"></span>
          </div>
        </div>
        <div class="amh-actions">
          <button class="amh-btn" onclick="indirimGoster()">% Ä°ndirim</button>
          <button class="amh-btn" onclick="transferGoster()">â†” Aktar</button>
          <button class="amh-btn" onclick="bolmeGoster()">âœ‚ BÃ¶l</button>
          <button class="amh-btn" onclick="fisYazdir()">ğŸ–¨ FiÅŸ</button>
          <button class="amh-btn" onclick="masaTemizle()">ğŸ—‘</button>
        </div>
      </div>
      <div class="adisyon-body">
        <div class="urun-bolumu">
          <div class="cat-tabs" id="cat-tabs"></div>
          <div class="urun-grid" id="urun-grid"></div>
        </div>
        <div class="siparis-bolumu">
          <div class="siparis-baslik">ğŸ›’ Adisyon</div>
          <div class="siparis-liste" id="siparis-liste"></div>
        </div>
      </div>
      <div class="adisyon-footer">
        <div class="toplam-alan">
          <div class="toplam-etiket">TOPLAM</div>
          <div class="toplam-onceki" id="toplam-onceki"></div>
          <div class="toplam-tutar" id="toplam-tutar">0,00 â‚º</div>
        </div>
        <div class="odeme-butonlar">
          <button class="btn-nakit" onclick="tahsilEt()">ğŸ’µ Nakit Tahsil</button>
          <button class="btn-bol" onclick="bolmeGoster()">âœ‚ HesabÄ± BÃ¶l</button>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="page" id="page-urun">
  <div class="page-urun">
    <div class="page-title">â• ÃœrÃ¼n / Kategori Ekle</div>
    <div class="form-group"><label>Kategori</label><select id="urun-kat"></select></div>
    <button class="btn-yeni-kat" onclick="yeniKategoriEkle()">+ Yeni Kategori Ekle</button>
    <div class="form-group"><label>ÃœrÃ¼n AdÄ±</label><input type="text" id="urun-adi" placeholder="Ã–rn: ViÅŸneli Soda"></div>
    <div class="form-group"><label>Fiyat (â‚º)</label><input type="number" id="urun-fiyat" placeholder="35" min="0" inputmode="numeric"></div>
    <div class="form-group"><label>Emoji Ä°kon</label><input type="text" id="urun-ikon" placeholder="ğŸ¥¤" maxlength="4"></div>
    <button class="btn-kaydet" onclick="urunKaydet()">âœ“ Kaydet</button>
    <div class="urun-listesi-baslik">Mevcut ÃœrÃ¼nler</div>
    <div id="urun-listesi"></div>
  </div>
</div>

<div class="page" id="page-rapor">
  <div class="page-rapor">
    <div class="page-title">ğŸ“Š Rapor</div>
    <div class="rapor-ozet">
      <div class="rapor-kart"><div class="rk-label">Ciro</div><div class="rk-val" id="r-ciro">0 â‚º</div></div>
      <div class="rapor-kart"><div class="rk-label">Adisyon</div><div class="rk-val" id="r-adi">0</div></div>
      <div class="rapor-kart"><div class="rk-label">ÃœrÃ¼n</div><div class="rk-val" id="r-urun">0</div></div>
      <div class="rapor-kart"><div class="rk-label">Ort.</div><div class="rk-val" id="r-ort">0 â‚º</div></div>
    </div>
    <div style="display:flex;gap:7px;margin-bottom:14px;flex-wrap:wrap;">
      <button class="donem-tab active" onclick="donemSec('gun',this)">ğŸ“… BugÃ¼n</button>
      <button class="donem-tab" onclick="donemSec('ay',this)">ğŸ“† Bu Ay</button>
      <button class="donem-tab" onclick="donemSec('yil',this)">ğŸ—“ Bu YÄ±l</button>
      <button class="donem-tab" onclick="donemSec('tum',this)">ğŸ“‹ TÃ¼mÃ¼</button>
    </div>
    <div class="rapor-tablo-baslik"><span>ÃœRÃœN</span><span>ADET</span><span>TUTAR</span></div>
    <div id="rapor-liste"></div>
    <div style="margin-top:16px;"><div class="rapor-tablo-baslik" style="margin-bottom:8px;"><span>GARSON PERFORMANSI</span></div><div id="garson-rapor"></div></div>
    <div style="margin-top:16px;"><div class="rapor-tablo-baslik" style="margin-bottom:8px;"><span>KAPATILAN ADÄ°SYONLAR</span></div><div id="kapali-liste"></div></div>
  </div>
</div>

<div class="page" id="page-ayarlar">
  <div class="page-ayarlar">
    <div class="page-title">âš™ï¸ Ayarlar</div>
    <div class="ayar-kart">
      <h3>Hesap</h3>
      <div class="ayar-row"><span class="ayar-label">Kafe AdÄ±</span><span class="ayar-val" id="ayar-kafe-adi">â€”</span></div>
      <div class="ayar-row"><span class="ayar-label">E-posta</span><span class="ayar-val" id="ayar-email">â€”</span></div>
      <div class="ayar-row"><span class="ayar-label">Plan</span><span class="plan-badge plan-ucretsiz" id="ayar-plan">Ãœcretsiz</span></div>
    </div>
    <div class="ayar-kart">
      <h3>Kafe AdÄ±nÄ± DeÄŸiÅŸtir</h3>
      <input type="text" id="yeni-kafe-adi" placeholder="Yeni kafe adÄ±..." style="width:100%;background:var(--surface3);border:1.5px solid var(--border);border-radius:10px;padding:11px 13px;color:var(--text);font-family:'Nunito',sans-serif;font-size:0.95rem;font-weight:600;outline:none;margin-bottom:10px;">
      <button class="ayar-btn" style="width:100%;" onclick="kafeAdiniGuncelle()">âœ“ GÃ¼ncelle</button>
    </div>
    <div class="ayar-kart">
      <h3>Garsonlar</h3>
      <div id="garson-ayar-liste"></div>
      <div style="display:flex;gap:7px;margin-top:8px;">
        <input type="text" id="yeni-garson-ayar" placeholder="Garson adÄ±..." style="flex:1;background:var(--surface3);border:1.5px solid var(--border);border-radius:10px;padding:10px 12px;color:var(--text);font-family:'Nunito',sans-serif;font-size:0.88rem;font-weight:600;outline:none;">
        <button onclick="garsonEkleAyar()" style="padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:var(--bg);font-family:'Nunito',sans-serif;font-weight:900;font-size:1rem;cursor:pointer;">+</button>
      </div>
    </div>
    <div class="ayar-kart">
      <h3>Pro Plan</h3>
      <p style="font-size:0.82rem;color:var(--muted);font-weight:600;margin-bottom:12px;">SÄ±nÄ±rsÄ±z masa, Ã¶ncelikli destek, geliÅŸmiÅŸ raporlar</p>
      <button style="width:100%;padding:13px;border-radius:12px;border:none;background:var(--accent);color:var(--bg);font-family:'Nunito',sans-serif;font-size:0.95rem;font-weight:900;cursor:pointer;" onclick="proPlanAc()">â­ Pro'ya GeÃ§ â€” 299â‚º/ay</button>
    </div>
    <div style="text-align:center;margin-top:16px;">
      <button onclick="cikisYap()" style="background:none;border:none;color:var(--muted);font-family:'Nunito',sans-serif;font-size:0.85rem;font-weight:700;cursor:pointer;">Ã‡Ä±kÄ±ÅŸ Yap</button>
    </div>
  </div>
</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav">
  <button class="bnav-btn active" id="nav-masalar" onclick="sayfaGit('masalar')"><div class="nav-icon">ğŸª‘</div>Masalar</button>
  <button class="bnav-btn" id="nav-adisyon" onclick="sayfaGit('adisyon')"><div class="nav-icon">ğŸ§¾</div>Adisyon</button>
  <button class="bnav-btn" id="nav-urun" onclick="sayfaGit('urun')"><div class="nav-icon">â•</div>ÃœrÃ¼n</button>
  <button class="bnav-btn" id="nav-rapor" onclick="sayfaGit('rapor')"><div class="nav-icon">ğŸ“Š</div>Rapor</button>
  <button class="bnav-btn" id="nav-ayarlar" onclick="sayfaGit('ayarlar')"><div class="nav-icon">âš™ï¸</div>Ayarlar</button>
</div>

</div><!-- /app -->

<!-- MODALLER -->
<div class="modal-overlay" id="not-modal">
  <div class="modal" style="max-width:340px;">
    <div class="modal-baslik" id="not-modal-baslik">Masa AyarlarÄ±</div>
    <label style="font-size:0.72rem;font-weight:700;color:var(--text2);display:block;margin-bottom:5px;">Masa AdÄ±</label>
    <input type="text" id="masa-ad-input" maxlength="16" placeholder="Ã¶rn: BahÃ§e, Teras, VIP..." style="width:100%;background:var(--surface2);border:1.5px solid var(--border);border-radius:11px;padding:11px 13px;color:var(--text);font-family:'Nunito',sans-serif;font-size:0.95rem;font-weight:700;outline:none;margin-bottom:11px;">
    <label style="font-size:0.72rem;font-weight:700;color:var(--text2);display:block;margin-bottom:5px;">KÄ±sa Not</label>
    <input type="text" id="not-input" maxlength="20" placeholder="Ã¶rn: pencere, sigara..." style="width:100%;background:var(--surface2);border:1.5px solid var(--border);border-radius:11px;padding:11px 13px;color:var(--text);font-family:'Nunito',sans-serif;font-size:0.95rem;font-weight:600;outline:none;margin-bottom:13px;">
    <button id="not-modal-kaydet" style="width:100%;padding:12px;border-radius:11px;border:none;background:var(--accent);color:var(--bg);font-family:'Nunito',sans-serif;font-size:0.95rem;font-weight:900;cursor:pointer;margin-bottom:7px;">âœ“ Kaydet</button>
    <button onclick="modalKapat('not-modal')" class="modal-kapat">Ä°ptal</button>
  </div>
</div>

<div class="modal-overlay" id="garson-modal">
  <div class="modal" style="max-width:340px;">
    <div class="modal-baslik">ğŸ‘¤ Garson SeÃ§</div>
    <div id="garson-liste-modal" style="margin-bottom:10px;"></div>
    <button onclick="modalKapat('garson-modal')" class="modal-kapat">Ä°ptal</button>
  </div>
</div>

<div class="modal-overlay" id="indirim-modal">
  <div class="modal" style="max-width:320px;">
    <div class="modal-baslik">% Ä°ndirim Uygula</div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:7px;margin-bottom:12px;">
      <button class="indirim-hizli-btn" onclick="indirimUygula(5)">%5</button>
      <button class="indirim-hizli-btn" onclick="indirimUygula(10)">%10</button>
      <button class="indirim-hizli-btn" onclick="indirimUygula(15)">%15</button>
      <button class="indirim-hizli-btn" onclick="indirimUygula(20)">%20</button>
      <button class="indirim-hizli-btn" onclick="indirimUygula(25)">%25</button>
      <button class="indirim-hizli-btn" onclick="indirimUygula(50)">%50</button>
    </div>
    <div style="display:flex;gap:7px;margin-bottom:11px;align-items:center;">
      <input type="number" id="indirim-input" min="0" max="100" placeholder="0" inputmode="numeric" style="flex:1;background:var(--surface2);border:1.5px solid var(--border);border-radius:10px;padding:11px 12px;color:var(--text);font-family:'Nunito',sans-serif;font-size:1.05rem;font-weight:800;outline:none;text-align:center;">
      <span style="font-size:1rem;font-weight:900;color:var(--accent2);">%</span>
    </div>
    <button onclick="indirimUygulaManuel()" style="width:100%;padding:12px;border-radius:11px;border:none;background:var(--accent);color:var(--bg);font-family:'Nunito',sans-serif;font-size:0.95rem;font-weight:900;cursor:pointer;margin-bottom:7px;">âœ“ Uygula</button>
    <button onclick="indirimKaldir()" style="width:100%;padding:9px;border-radius:11px;border:1.5px solid var(--danger);background:transparent;color:var(--danger);font-family:'Nunito',sans-serif;font-size:0.82rem;font-weight:700;cursor:pointer;margin-bottom:7px;">âœ• Ä°ndirimi KaldÄ±r</button>
    <button onclick="modalKapat('indirim-modal')" class="modal-kapat">Ä°ptal</button>
  </div>
</div>

<div class="modal-overlay" id="transfer-modal">
  <div class="modal">
    <div class="modal-baslik">â†” Masa Aktar</div>
    <p style="font-size:0.82rem;color:var(--muted);font-weight:600;margin-bottom:12px;">Hangi masaya aktarÄ±lsÄ±n?</p>
    <div class="transfer-grid" id="transfer-grid"></div>
    <button class="modal-kapat" onclick="modalKapat('transfer-modal')">Ä°ptal</button>
  </div>
</div>

<div class="modal-overlay" id="split-modal">
  <div class="modal">
    <div class="modal-baslik">âœ‚ Hesap BÃ¶lme</div>
    <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;">
      <label style="font-size:0.88rem;font-weight:700;color:var(--text2);">KiÅŸi sayÄ±sÄ±:</label>
      <input type="number" id="split-kisi" value="2" min="2" max="20" inputmode="numeric" oninput="splitRender()" style="width:70px;background:var(--surface2);border:1.5px solid var(--border);border-radius:9px;padding:9px;color:var(--text);font-family:'Nunito',sans-serif;font-size:0.95rem;font-weight:700;text-align:center;outline:none;">
    </div>
    <div id="split-liste"></div>
    <button class="modal-kapat" onclick="modalKapat('split-modal')">Kapat</button>
  </div>
</div>

<!-- FÄ°Å MODAL -->
<div class="fis-yazdir-modal" id="fis-modal">
  <div id="fis-yazdir-icerik"></div>
  <div style="width:100%;max-width:310px;margin-top:8px;display:flex;gap:7px;">
    <button class="fis-btn baglan" onclick="btBaglan()">ğŸ“¡ BaÄŸla</button>
    <button class="fis-btn yazdir" onclick="yazdir()">ğŸ–¨ GÃ¶nder</button>
    <button class="fis-btn kapat" onclick="document.getElementById('fis-modal').classList.remove('ac')">âœ•</button>
  </div>
</div>

<div class="toast" id="toast"></div>
<div class="yukleniyor" id="yukleniyor"><div class="yukleniyor-ic"><div class="spinner"></div><p>Kaydediliyor...</p></div></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SUPABASE BAÅLAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = 'https://sjfcdthwlwmbdmcevobv.supabase.co';
const SUPABASE_KEY = 'sb_publishable_XQCQ7YxwAgTEOqlmY88uGw_Ji5RCKLF';
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UYGULAMA STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let kullanici = null;
let kafeId = null;
let kafeAdi = 'Kafem';
let masalar = Array.from({length:20}, (_,i) => ({id:i+1, ad:'Masa '+(i+1), siparisler:[], not:'', garson:'', indirim:0}));
let garsonlar = [];
let URUNLER = {
  'SÄ±cak Ä°Ã§ecekler': [
    {isim:'TÃ¼rk Kahvesi',fiyat:40,ikon:'â˜•'},{isim:'Nescafe',fiyat:45,ikon:'â˜•'},
    {isim:'SÃ¼tlÃ¼ Nescafe',fiyat:50,ikon:'â˜•'},{isim:'Ã‡ay',fiyat:15,ikon:'ğŸµ'},
    {isim:'Bitki Ã‡ayÄ±',fiyat:35,ikon:'ğŸŒ¿'},{isim:'Sahlep',fiyat:50,ikon:'ğŸ¥›'},
  ],
  'SoÄŸuk Ä°Ã§ecekler': [
    {isim:'Soda',fiyat:25,ikon:'ğŸ¾'},{isim:'Su',fiyat:10,ikon:'ğŸ’§'},
    {isim:'Kola',fiyat:35,ikon:'ğŸ¥¤'},{isim:'Fanta',fiyat:35,ikon:'ğŸŠ'},
    {isim:'Sprite',fiyat:35,ikon:'ğŸ‹'},{isim:'Ayran',fiyat:20,ikon:'ğŸ¥›'},
    {isim:'Limonata',fiyat:50,ikon:'ğŸ‹'},{isim:'Taze SÄ±kma',fiyat:55,ikon:'ğŸ¹'},
  ],
  'Meyve SularÄ±': [
    {isim:'Nar Suyu',fiyat:45,ikon:'ğŸ·'},{isim:'Portakal Suyu',fiyat:40,ikon:'ğŸŠ'},
    {isim:'Elma Suyu',fiyat:35,ikon:'ğŸ'},{isim:'ViÅŸne Suyu',fiyat:35,ikon:'ğŸ’'},
  ],
  'AtÄ±ÅŸtÄ±rmalÄ±k': [
    {isim:'Tost',fiyat:60,ikon:'ğŸ¥ª'},{isim:'SandviÃ§',fiyat:70,ikon:'ğŸ¥™'},
    {isim:'PoÄŸaÃ§a',fiyat:25,ikon:'ğŸ¥'},{isim:'Kurabiye',fiyat:15,ikon:'ğŸª'},
    {isim:'Kek',fiyat:35,ikon:'ğŸ‚'},
  ],
};
let seciliMasa = null;
let mevcutKat = Object.keys(URUNLER)[0];
let kapaliAdisyonlar = [];
let gunlukCiro = 0;
let gunlukAdi = 0;
let gunlukSatis = {};
let splitOdendi = [];
let aktifDonem = 'gun';
let btYazici = null;
let _kayitTimeout = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function authTab(tab) {
  document.getElementById('tab-giris').classList.toggle('active', tab==='giris');
  document.getElementById('tab-kayit').classList.toggle('active', tab==='kayit');
  document.getElementById('auth-giris').style.display = tab==='giris'?'block':'none';
  document.getElementById('auth-kayit').style.display = tab==='kayit'?'block':'none';
  document.getElementById('auth-err').style.display = 'none';
}

function authHata(msg) {
  const el = document.getElementById('auth-err');
  el.textContent = msg; el.style.display = 'block';
  document.getElementById('auth-loading').style.display = 'none';
}

async function girisYap() {
  const email = document.getElementById('giris-email').value.trim();
  const sifre = document.getElementById('giris-sifre').value;
  if (!email||!sifre) { authHata('E-posta ve ÅŸifre girin!'); return; }
  document.getElementById('auth-loading').style.display = 'block';
  document.getElementById('auth-err').style.display = 'none';
  const {data, error} = await sb.auth.signInWithPassword({email, password: sifre});
  if (error) { authHata(error.message==='Invalid login credentials'?'E-posta veya ÅŸifre hatalÄ±!':error.message); return; }
  await uygulamaBaslat(data.user);
}

async function kayitOl() {
  const kafe = document.getElementById('kayit-kafe').value.trim();
  const email = document.getElementById('kayit-email').value.trim();
  const sifre = document.getElementById('kayit-sifre').value;
  if (!kafe) { authHata('Kafe adÄ± girin!'); return; }
  if (!email) { authHata('E-posta girin!'); return; }
  if (sifre.length<6) { authHata('Åifre en az 6 karakter olmalÄ±!'); return; }
  document.getElementById('auth-loading').style.display = 'block';
  document.getElementById('auth-err').style.display = 'none';
  const {data, error} = await sb.auth.signUp({email, password: sifre});
  if (error) { authHata(error.message); return; }
  // Kafe profili oluÅŸtur
  await sb.from('kafeler').insert({user_id: data.user.id, kafe_adi: kafe, plan: 'ucretsiz', garsonlar: ['Ali','AyÅŸe']});
  await uygulamaBaslat(data.user);
}

async function cikisYap() {
  await sb.auth.signOut();
  location.reload();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UYGULAMA BAÅLAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function uygulamaBaslat(user) {
  kullanici = user;
  document.getElementById('auth-screen').style.display = 'none';
  const appEl = document.getElementById('app');
  appEl.style.display = 'flex';
  appEl.style.flexDirection = 'column';
  document.getElementById('ayar-email').textContent = user.email;
  await kafeVerisiYukle();
  await adisyonVerisiYukle();
  masalarRender();
  urunListesiRender();
  setSyncOnline(true);
}

async function kafeVerisiYukle() {
  const {data} = await sb.from('kafeler').select('*').eq('user_id', kullanici.id).single();
  if (data) {
    kafeId = data.id;
    kafeAdi = data.kafe_adi || 'Kafem';
    garsonlar = data.garsonlar || ['Ali','AyÅŸe'];
    if (data.urunler) URUNLER = data.urunler;
    if (data.masalar) {
      const kayitliMasalar = data.masalar;
      masalar.forEach(m => {
        const k = kayitliMasalar.find(x=>x.id===m.id);
        if (k) { m.ad = k.ad; m.not = k.not||''; }
      });
    }
  } else {
    // Ä°lk giriÅŸ, kafe verisi henÃ¼z yok
    const {data:yeni} = await sb.from('kafeler').insert({user_id: kullanici.id, kafe_adi: 'Kafem', plan:'ucretsiz', garsonlar:['Ali','AyÅŸe']}).select().single();
    if (yeni) { kafeId = yeni.id; garsonlar = ['Ali','AyÅŸe']; }
  }
  document.getElementById('header-kafe-adi').textContent = kafeAdi;
  document.getElementById('ayar-kafe-adi').textContent = kafeAdi;
  document.getElementById('yeni-kafe-adi').value = kafeAdi;
  garsonAyarListeRender();
}

async function adisyonVerisiYukle() {
  // BugÃ¼nÃ¼n adisyonlarÄ±nÄ± yÃ¼kle (son 30 gÃ¼n)
  const otuzGunOnce = new Date(); otuzGunOnce.setDate(otuzGunOnce.getDate()-30);
  const {data} = await sb.from('adisyonlar').select('*')
    .eq('kafe_id', kafeId)
    .gte('created_at', otuzGunOnce.toISOString())
    .order('created_at', {ascending:false});
  if (data) {
    kapaliAdisyonlar = data.map(a => ({
      masa: a.masa_no,
      masaAd: a.masa_ad||'Masa '+a.masa_no,
      tarih: new Date(a.created_at).toLocaleString('tr-TR'),
      tarihObj: new Date(a.created_at),
      toplam: a.toplam,
      indirim: a.indirim||0,
      garson: a.garson||'',
      siparisler: a.siparisler||[],
    }));
    // GÃ¼nlÃ¼k istatistik
    const bugun = new Date().toDateString();
    kapaliAdisyonlar.filter(a=>new Date(a.tarihObj).toDateString()===bugun).forEach(a=>{
      gunlukCiro += a.toplam; gunlukAdi++;
      a.siparisler.forEach(s=>{
        if(!gunlukSatis[s.isim]) gunlukSatis[s.isim]={adet:0,toplam:0};
        gunlukSatis[s.isim].adet+=s.adet;
        gunlukSatis[s.isim].toplam+=s.fiyat*s.adet;
      });
    });
  }
  masalarRender();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BULUT KAYIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function bulutKaydet() {
  clearTimeout(_kayitTimeout);
  _kayitTimeout = setTimeout(async () => {
    if (!kafeId) return;
    const masaKayit = masalar.map(m=>({id:m.id,ad:m.ad,not:m.not||''}));
    await sb.from('kafeler').update({
      urunler: URUNLER,
      masalar: masaKayit,
      garsonlar: garsonlar
    }).eq('id', kafeId);
  }, 1200);
}

async function adisyonKaydet(adisyon) {
  if (!kafeId) return;
  await sb.from('adisyonlar').insert({
    kafe_id: kafeId,
    masa_no: adisyon.masa,
    masa_ad: adisyon.masaAd,
    toplam: adisyon.toplam,
    indirim: adisyon.indirim||0,
    garson: adisyon.garson||'',
    siparisler: adisyon.siparisler,
  });
}

function setSyncOnline(online) {
  document.getElementById('sync-dot').className = 'sync-dot' + (online?'':' offline');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SAYFA NAVÄ°GASYON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function sayfaGit(sayfa) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.bnav-btn').forEach(b=>b.classList.remove('active'));
  document.getElementById('page-'+sayfa).classList.add('active');
  document.getElementById('nav-'+sayfa).classList.add('active');
  if (sayfa==='rapor') raporRender();
  if (sayfa==='urun') urunListesiRender();
  if (sayfa==='adisyon') adisyonGuncelle();
  if (sayfa==='ayarlar') ayarlarRender();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MASALAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function masalarRender() {
  const grid = document.getElementById('masalar-grid');
  grid.innerHTML = '';
  let dolu = 0;
  masalar.forEach(m => {
    const toplam = masaToplam(m);
    const var_ = m.siparisler.length>0;
    if (var_) dolu++;
    const btn = document.createElement('button');
    btn.className = 'masa-kart'+(seciliMasa===m.id?' secili':'')+(var_?' dolu':'');
    btn.innerHTML = `
      <div class="mn">${m.id}</div>
      <div class="mad">${m.ad!=='Masa '+m.id?m.ad:(m.not||'Masa '+m.id)}</div>
      ${m.garson?`<div class="mgarson">${m.garson}</div>`:''}
      ${var_?`<div class="mt">${fmt(toplam)}</div>`:''}
      ${var_?`<div class="mb">${m.siparisler.reduce((s,o)=>s+o.adet,0)}</div>`:''}
      <button class="masa-not-btn">âœï¸</button>
    `;
    btn.querySelector('.masa-not-btn').addEventListener('click',e=>{e.stopPropagation();masaNotDuzenle(m.id);});
    btn.addEventListener('click',()=>{seciliMasa=m.id;masalarRender();adisyonGuncelle();sayfaGit('adisyon');});
    grid.appendChild(btn);
  });
  document.getElementById('hstat-dolu').textContent = dolu+'/20';
  document.getElementById('hstat-ciro').textContent = Math.round(gunlukCiro)+'â‚º';
}

function masaToplam(m) { return m.siparisler.reduce((s,o)=>s+o.fiyat*o.adet,0); }

function masaNotDuzenle(id) {
  const m = masalar[id-1];
  document.getElementById('not-modal-baslik').textContent = 'Masa '+id+' AyarlarÄ±';
  document.getElementById('masa-ad-input').value = m.ad;
  document.getElementById('not-input').value = m.not||'';
  document.getElementById('not-modal-kaydet').onclick = () => {
    masalar[id-1].ad = (document.getElementById('masa-ad-input').value.trim()||('Masa '+id)).substring(0,16);
    masalar[id-1].not = document.getElementById('not-input').value.trim().substring(0,20);
    modalKapat('not-modal');
    masalarRender();
    if(seciliMasa===id) adisyonGuncelle();
    bulutKaydet();
  };
  modalAc('not-modal');
  setTimeout(()=>document.getElementById('masa-ad-input').focus(),200);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ADÄ°SYON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function adisyonGuncelle() {
  if (!seciliMasa) {
    document.getElementById('masa-secilmedi-msg').style.display='flex';
    document.getElementById('adisyon-icerik').style.display='none';
    return;
  }
  document.getElementById('masa-secilmedi-msg').style.display='none';
  document.getElementById('adisyon-icerik').style.display='flex';
  const m = masalar[seciliMasa-1];
  document.getElementById('adisyon-masa-basligi').textContent = m.ad;
  const gc = document.getElementById('garson-chip');
  gc.textContent = m.garson?'ğŸ‘¤ '+m.garson:'ğŸ‘¤ Garson';
  document.getElementById('indirim-chip-goster').innerHTML = m.indirim>0?`<span class="indirim-chip">-%${m.indirim}</span>`:'';
  katTabsRender(); urunGridRender(); siparisListeRender();
}

function katTabsRender() {
  const tabs = document.getElementById('cat-tabs');
  tabs.innerHTML='';
  Object.keys(URUNLER).forEach(kat=>{
    const btn=document.createElement('button');
    btn.className='cat-tab'+(kat===mevcutKat?' active':'');
    btn.textContent=kat;
    btn.addEventListener('click',()=>{mevcutKat=kat;katTabsRender();urunGridRender();});
    tabs.appendChild(btn);
  });
}

function urunGridRender() {
  const grid=document.getElementById('urun-grid');
  grid.innerHTML='';
  (URUNLER[mevcutKat]||[]).forEach((u,idx)=>{
    const kart=document.createElement('div');
    kart.className='urun-kart';
    kart.innerHTML=`<div class="ui">${u.ikon}</div><div class="un">${u.isim}</div><div class="up">${u.fiyat} â‚º</div><button class="udel">âœ•</button>`;
    kart.querySelector('.udel').addEventListener('click',e=>{
      e.stopPropagation();
      if(!confirm('"'+u.isim+'" silinsin mi?')) return;
      URUNLER[mevcutKat].splice(idx,1);
      urunGridRender(); urunListesiRender(); bulutKaydet(); toast('ÃœrÃ¼n silindi');
    });
    kart.addEventListener('click',e=>{if(e.target.classList.contains('udel')) return;urunEkle(u);});
    grid.appendChild(kart);
  });
}

function urunEkle(u) {
  if(!seciliMasa) return;
  const m=masalar[seciliMasa-1];
  const v=m.siparisler.find(s=>s.isim===u.isim);
  if(v) v.adet++;
  else m.siparisler.push({isim:u.isim,fiyat:u.fiyat,adet:1});
  siparisListeRender(); masalarRender();
}

function siparisListeRender() {
  const liste=document.getElementById('siparis-liste');
  if(!seciliMasa) return;
  const m=masalar[seciliMasa-1];
  if(m.siparisler.length===0) {
    liste.innerHTML='<div class="bos-durum"><div class="bi">ğŸ›’</div><p>HenÃ¼z Ã¼rÃ¼n eklenmedi</p></div>';
  } else {
    liste.innerHTML='';
    m.siparisler.forEach((s,i)=>{
      const item=document.createElement('div');
      item.className='siparis-item';
      item.innerHTML=`
        <span class="si-isim">${s.isim}</span>
        <div class="si-miktar">
          <button class="si-btn" onclick="mikDeg(${i},-1)">âˆ’</button>
          <span class="si-sayi">${s.adet}</span>
          <button class="si-btn" onclick="mikDeg(${i},1)">+</button>
        </div>
        <span class="si-fiyat">${fmt(s.fiyat*s.adet)}</span>
        <button class="si-sil" onclick="siparisKaldir(${i})">âœ•</button>`;
      liste.appendChild(item);
    });
  }
  const ham=masaToplam(m), ind=m.indirim||0, son=ham*(1-ind/100);
  const oncEl=document.getElementById('toplam-onceki');
  if(ind>0){oncEl.style.display='block';oncEl.textContent=fmt(ham);document.getElementById('toplam-tutar').textContent=fmt(son)+' (-%'+ind+')';}
  else{oncEl.style.display='none';document.getElementById('toplam-tutar').textContent=fmt(ham);}
}

function mikDeg(idx,d) {
  if(!seciliMasa) return;
  const m=masalar[seciliMasa-1];
  m.siparisler[idx].adet+=d;
  if(m.siparisler[idx].adet<=0) m.siparisler.splice(idx,1);
  siparisListeRender(); masalarRender();
}

function siparisKaldir(idx) {
  if(!seciliMasa) return;
  masalar[seciliMasa-1].siparisler.splice(idx,1);
  siparisListeRender(); masalarRender();
}

function masaTemizle() {
  if(!seciliMasa) return;
  if(!confirm('Masa temizlensin mi?')) return;
  masalar[seciliMasa-1].siparisler=[];
  masalar[seciliMasa-1].indirim=0;
  masalar[seciliMasa-1].garson='';
  siparisListeRender(); masalarRender(); adisyonGuncelle();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAHSÄ°L
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function tahsilEt() {
  if(!seciliMasa) return;
  const m=masalar[seciliMasa-1];
  if(m.siparisler.length===0){toast('Adisyon boÅŸ!');return;}
  const ham=masaToplam(m), son=ham*(1-(m.indirim||0)/100);
  const adisyon={
    masa:seciliMasa, masaAd:m.ad,
    tarih:new Date().toLocaleString('tr-TR'), tarihObj:new Date(),
    toplam:son, indirim:m.indirim||0, garson:m.garson||'',
    siparisler:m.siparisler.map(s=>({...s}))
  };
  kapaliAdisyonlar.unshift(adisyon);
  gunlukCiro+=son; gunlukAdi++;
  m.siparisler.forEach(s=>{
    if(!gunlukSatis[s.isim]) gunlukSatis[s.isim]={adet:0,toplam:0};
    gunlukSatis[s.isim].adet+=s.adet;
    gunlukSatis[s.isim].toplam+=s.fiyat*s.adet;
  });
  m.siparisler=[]; m.indirim=0; m.garson='';
  adisyonGuncelle(); siparisListeRender(); masalarRender();
  toast('âœ“ '+m.ad+' â€” '+fmt(son)+' tahsil edildi');
  await adisyonKaydet(adisyon);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// Ä°NDÄ°RÄ°M
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function indirimGoster(){if(!seciliMasa) return;document.getElementById('indirim-input').value=masalar[seciliMasa-1].indirim||'';modalAc('indirim-modal');}
function indirimUygula(oran){if(!seciliMasa) return;masalar[seciliMasa-1].indirim=oran;modalKapat('indirim-modal');adisyonGuncelle();siparisListeRender();toast('âœ“ %'+oran+' indirim uygulandÄ±');}
function indirimUygulaManuel(){const v=parseInt(document.getElementById('indirim-input').value);if(isNaN(v)||v<0||v>100){toast('0-100 arasÄ± girin!');return;}indirimUygula(v);}
function indirimKaldir(){if(!seciliMasa) return;masalar[seciliMasa-1].indirim=0;modalKapat('indirim-modal');adisyonGuncelle();siparisListeRender();toast('Ä°ndirim kaldÄ±rÄ±ldÄ±');}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GARSON
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function garsonSec(){
  if(!seciliMasa) return;
  const liste=document.getElementById('garson-liste-modal');
  liste.innerHTML='';
  garsonlar.forEach(g=>{
    const btn=document.createElement('button');
    const secili=masalar[seciliMasa-1].garson===g;
    btn.style.cssText=`width:100%;padding:11px 13px;margin-bottom:6px;border-radius:10px;border:1.5px solid ${secili?'var(--accent2)':'var(--border)'};background:${secili?'var(--surface3)':'var(--surface2)'};color:${secili?'var(--accent2)':'var(--text)'};font-family:'Nunito',sans-serif;font-size:0.88rem;font-weight:700;cursor:pointer;text-align:left;display:flex;justify-content:space-between;`;
    btn.innerHTML=`<span>ğŸ‘¤ ${g}</span>${secili?'<span>âœ“</span>':''}`;
    btn.addEventListener('click',()=>{
      masalar[seciliMasa-1].garson=secili?'':g;
      modalKapat('garson-modal'); adisyonGuncelle(); masalarRender();
      toast(secili?'Garson kaldÄ±rÄ±ldÄ±':'âœ“ Garson: '+g);
    });
    liste.appendChild(btn);
  });
  if(garsonlar.length===0) liste.innerHTML='<p style="color:var(--muted);font-size:0.85rem;text-align:center;padding:12px;">Ayarlar\'dan garson ekleyin</p>';
  modalAc('garson-modal');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TRANSFER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function transferGoster(){
  if(!seciliMasa) return;
  const grid=document.getElementById('transfer-grid');
  grid.innerHTML='';
  masalar.forEach(m=>{
    const btn=document.createElement('button');
    btn.className='tr-btn'+(m.siparisler.length>0?' dolu-t':'');
    btn.textContent=m.id; if(m.id===seciliMasa) btn.disabled=true;
    btn.onclick=()=>transferYap(m.id);
    grid.appendChild(btn);
  });
  modalAc('transfer-modal');
}

function transferYap(hedefId){
  const k=masalar[seciliMasa-1],h=masalar[hedefId-1];
  k.siparisler.forEach(s=>{const v=h.siparisler.find(x=>x.isim===s.isim);if(v) v.adet+=s.adet;else h.siparisler.push({...s});});
  const kid=seciliMasa; k.siparisler=[];
  modalKapat('transfer-modal'); seciliMasa=hedefId; adisyonGuncelle(); masalarRender();
  toast('â†” Masa '+kid+' â†’ Masa '+hedefId);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HESAP BÃ–LME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function bolmeGoster(){
  if(!seciliMasa) return;
  const m=masalar[seciliMasa-1];
  if(m.siparisler.length===0){toast('Adisyon boÅŸ!');return;}
  splitOdendi=[]; document.getElementById('split-kisi').value=2; splitRender(); modalAc('split-modal');
}

function splitRender(){
  const sayi=parseInt(document.getElementById('split-kisi').value)||2;
  if(!seciliMasa) return;
  const m=masalar[seciliMasa-1];
  const ham=masaToplam(m),ind=m.indirim||0,toplam=ham*(1-ind/100),kb=toplam/sayi;
  const liste=document.getElementById('split-liste');
  liste.innerHTML='';
  for(let i=0;i<sayi;i++){
    const od=splitOdendi.includes(i);
    const item=document.createElement('div'); item.className='split-item';
    item.innerHTML=`<span class="spi-isim">ğŸ‘¤ KiÅŸi ${i+1}</span><span class="spi-tutar">${fmt(kb)}</span>${od?'<span class="spi-odendi">âœ“ Ã–dendi</span>':`<button class="spi-tahsil">Tahsil</button>`}`;
    if(!od) item.querySelector('.spi-tahsil').addEventListener('click',()=>splitOde(i,sayi,kb,toplam,m));
    liste.appendChild(item);
  }
  if(splitOdendi.length===sayi&&sayi>0){
    setTimeout(()=>{
      const adisyon={masa:seciliMasa,masaAd:m.ad,tarih:new Date().toLocaleString('tr-TR'),tarihObj:new Date(),toplam,indirim:ind,garson:m.garson||'',siparisler:m.siparisler.map(s=>({...s}))};
      kapaliAdisyonlar.unshift(adisyon); gunlukAdi++;
      m.siparisler.forEach(s=>{if(!gunlukSatis[s.isim]) gunlukSatis[s.isim]={adet:0,toplam:0};gunlukSatis[s.isim].adet+=s.adet;gunlukSatis[s.isim].toplam+=s.fiyat*s.adet;});
      m.siparisler=[]; m.indirim=0; m.garson='';
      siparisListeRender(); masalarRender(); adisyonGuncelle();
      modalKapat('split-modal'); toast('âœ“ '+sayi+' kiÅŸi Ã¶dedi â€” '+fmt(toplam));
      adisyonKaydet(adisyon);
    },400);
  }
}

function splitOde(idx,sayi,kb,toplam,m){
  splitOdendi.push(idx); gunlukCiro+=kb; masalarRender(); splitRender();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ÃœRÃœN YÃ–NETÄ°MÄ°
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function katSelectDoldur(){
  const sel=document.getElementById('urun-kat'); sel.innerHTML='';
  Object.keys(URUNLER).forEach(k=>{const o=document.createElement('option');o.value=k;o.textContent=k;sel.appendChild(o);});
}

function yeniKategoriEkle(){
  const isim=prompt('Kategori adÄ±:');
  if(!isim||!isim.trim()) return;
  if(URUNLER[isim.trim()]){toast('Bu kategori zaten var!');return;}
  URUNLER[isim.trim()]=[];
  katSelectDoldur(); document.getElementById('urun-kat').value=isim.trim(); katTabsRender(); bulutKaydet(); toast('âœ“ Kategori eklendi');
}

function urunKaydet(){
  const kat=document.getElementById('urun-kat').value;
  const isim=document.getElementById('urun-adi').value.trim();
  const fiyat=parseFloat(document.getElementById('urun-fiyat').value);
  const ikon=document.getElementById('urun-ikon').value.trim()||'ğŸ¥¤';
  if(!isim){toast('ÃœrÃ¼n adÄ± girin!');return;}
  if(isNaN(fiyat)||fiyat<0){toast('GeÃ§erli fiyat girin!');return;}
  URUNLER[kat].push({isim,fiyat,ikon});
  document.getElementById('urun-adi').value='';
  document.getElementById('urun-fiyat').value='';
  document.getElementById('urun-ikon').value='';
  urunListesiRender(); katTabsRender(); if(mevcutKat===kat) urunGridRender(); bulutKaydet(); toast('âœ“ "'+isim+'" eklendi');
}

function urunListesiRender(){
  katSelectDoldur();
  const liste=document.getElementById('urun-listesi'); liste.innerHTML='';
  Object.entries(URUNLER).forEach(([kat,urunler])=>{
    urunler.forEach((u,idx)=>{
      const item=document.createElement('div'); item.className='urun-listesi-item';
      item.innerHTML=`<div class="uli-icon">${u.ikon}</div><div class="uli-info"><div class="uli-isim">${u.isim}</div><div class="uli-cat">${kat}</div></div><div class="uli-fiyat-wrap"><input class="uli-fiyat-input" type="number" value="${u.fiyat}" min="0" inputmode="numeric"><span class="uli-tl">â‚º</span></div><button class="uli-sil">ğŸ—‘</button>`;
      item.querySelector('.uli-fiyat-input').addEventListener('change',e=>{
        const f=parseFloat(e.target.value);
        if(isNaN(f)||f<0){e.target.value=u.fiyat;toast('GeÃ§ersiz fiyat!');return;}
        URUNLER[kat][idx].fiyat=f; if(mevcutKat===kat) urunGridRender(); bulutKaydet(); toast('âœ“ Fiyat gÃ¼ncellendi: '+fmt(f));
      });
      item.querySelector('.uli-sil').addEventListener('click',()=>{
        if(!confirm('"'+u.isim+'" silinsin mi?')) return;
        URUNLER[kat].splice(idx,1); urunListesiRender(); if(mevcutKat===kat) urunGridRender(); bulutKaydet(); toast('ÃœrÃ¼n silindi');
      });
      liste.appendChild(item);
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RAPOR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function donemSec(donem,btn){aktifDonem=donem;document.querySelectorAll('.donem-tab').forEach(b=>b.classList.remove('active'));btn.classList.add('active');raporRender();}

function donemFiltrele(adisyonlar){
  const simdi=new Date();
  return adisyonlar.filter(a=>{
    if(!a.tarihObj) return aktifDonem==='tum';
    const t=new Date(a.tarihObj);
    if(aktifDonem==='gun') return t.toDateString()===simdi.toDateString();
    if(aktifDonem==='ay') return t.getMonth()===simdi.getMonth()&&t.getFullYear()===simdi.getFullYear();
    if(aktifDonem==='yil') return t.getFullYear()===simdi.getFullYear();
    return true;
  });
}

function gunEtiketi(t){
  const simdi=new Date(),d=new Date(t);
  if(d.toDateString()===simdi.toDateString()) return 'BugÃ¼n';
  const dun=new Date(simdi);dun.setDate(simdi.getDate()-1);
  if(d.toDateString()===dun.toDateString()) return 'DÃ¼n';
  return d.toLocaleDateString('tr-TR',{day:'numeric',month:'long',year:'numeric'});
}

function raporRender(){
  const filtre=donemFiltrele(kapaliAdisyonlar);
  const toplamCiro=filtre.reduce((s,a)=>s+a.toplam,0);
  const toplamAdi=filtre.length;
  const ds={};
  filtre.forEach(a=>a.siparisler.forEach(s=>{if(!ds[s.isim])ds[s.isim]={adet:0,toplam:0};ds[s.isim].adet+=s.adet;ds[s.isim].toplam+=s.fiyat*s.adet;}));
  const toplamAdet=Object.values(ds).reduce((s,d)=>s+d.adet,0);
  document.getElementById('r-ciro').textContent=fmt(toplamCiro);
  document.getElementById('r-adi').textContent=toplamAdi;
  document.getElementById('r-urun').textContent=toplamAdet;
  document.getElementById('r-ort').textContent=toplamAdi>0?fmt(toplamCiro/toplamAdi):'0 â‚º';
  // ÃœrÃ¼n listesi
  const rl=document.getElementById('rapor-liste');
  const girdi=Object.entries(ds).sort((a,b)=>b[1].toplam-a[1].toplam);
  rl.innerHTML=girdi.length===0?'<div class="bos-rapor">â˜• Bu dÃ¶nemde satÄ±ÅŸ yok</div>':'';
  girdi.forEach(([isim,d])=>{const s=document.createElement('div');s.className='rapor-satir';s.innerHTML=`<span class="rs-isim">${isim}</span><span class="rs-adet">${d.adet}x</span><span class="rs-tutar">${fmt(d.toplam)}</span>`;rl.appendChild(s);});
  // Garson performansÄ±
  const gr=document.getElementById('garson-rapor');
  const gs={};
  filtre.forEach(a=>{if(!a.garson) return;if(!gs[a.garson])gs[a.garson]={adet:0,ciro:0};gs[a.garson].adet++;gs[a.garson].ciro+=a.toplam;});
  gr.innerHTML=Object.keys(gs).length===0?'<div class="bos-rapor" style="padding:10px;">Garson kaydÄ± yok</div>':'';
  Object.entries(gs).sort((a,b)=>b[1].ciro-a[1].ciro).forEach(([g,s])=>{const d=document.createElement('div');d.className='rapor-satir';d.innerHTML=`<span class="rs-isim">ğŸ‘¤ ${g}</span><span class="rs-adet">${s.adet} masa</span><span class="rs-tutar">${fmt(s.ciro)}</span>`;gr.appendChild(d);});
  // KapalÄ± adisyonlar
  const kl=document.getElementById('kapali-liste');
  if(filtre.length===0){kl.innerHTML='<div class="bos-rapor">Bu dÃ¶nemde adisyon yok</div>';return;}
  const grupla=a=>{if(!a.tarihObj) return 'Bilinmiyor';if(aktifDonem==='gun') return gunEtiketi(a.tarihObj);return new Date(a.tarihObj).toLocaleDateString('tr-TR',{month:'long',year:'numeric'});};
  const gruplar={};
  [...filtre].forEach(a=>{const k=grupla(a);if(!gruplar[k])gruplar[k]={adisyonlar:[],toplam:0};gruplar[k].adisyonlar.push(a);gruplar[k].toplam+=a.toplam;});
  kl.innerHTML='';
  Object.entries(gruplar).forEach(([baslik,grup])=>{
    const h=document.createElement('div');
    h.style.cssText='display:flex;justify-content:space-between;padding:7px 3px 5px;margin-top:5px;border-bottom:1px solid var(--border);margin-bottom:5px;';
    h.innerHTML=`<span style="font-size:0.75rem;font-weight:900;color:var(--text2);text-transform:uppercase;letter-spacing:1px;">${baslik}</span><span style="font-size:0.8rem;font-weight:900;color:var(--accent2);">${fmt(grup.toplam)}</span>`;
    kl.appendChild(h);
    grup.adisyonlar.forEach(a=>{
      const div=document.createElement('div');
      div.style.cssText='background:var(--surface2);border:1px solid var(--border);border-radius:11px;padding:10px 12px;margin-bottom:6px;';
      const saat=a.tarihObj?new Date(a.tarihObj).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}):a.tarih;
      const urunOzet=a.siparisler.map(s=>s.isim+' x'+s.adet).join(' Â· ');
      div.innerHTML=`
        <div style="display:flex;justify-content:space-between;margin-bottom:2px;">
          <span style="font-weight:800;font-size:0.9rem;">ğŸª‘ ${a.masaAd||'Masa '+a.masa} <span style="font-size:0.7rem;color:var(--muted);">Â· ${saat}</span></span>
          <span style="font-weight:900;color:var(--accent2);">${fmt(a.toplam)}${a.indirim?`<span class="indirim-chip">-%${a.indirim}</span>`:''}</span>
        </div>
        ${a.garson?`<div style="font-size:0.68rem;color:var(--accent);font-weight:700;margin-bottom:2px;">ğŸ‘¤ ${a.garson}</div>`:''}
        <div style="font-size:0.73rem;color:var(--text2);margin-bottom:7px;">${urunOzet}</div>
        <button class="fis-al-btn">ğŸ–¨ FiÅŸ Al</button>`;
      div.querySelector('.fis-al-btn').addEventListener('click',()=>fisGoster(a.masa,a.tarih,a.siparisler,a.toplam,a.garson||'',a.indirim||0,a.masaAd||''));
      kl.appendChild(div);
    });
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AYARLAR
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function ayarlarRender(){
  document.getElementById('ayar-kafe-adi').textContent=kafeAdi;
  document.getElementById('yeni-kafe-adi').value=kafeAdi;
  garsonAyarListeRender();
}

function garsonAyarListeRender(){
  const el=document.getElementById('garson-ayar-liste'); el.innerHTML='';
  garsonlar.forEach((g,i)=>{
    const row=document.createElement('div');
    row.style.cssText='display:flex;align-items:center;justify-content:space-between;padding:9px 0;border-bottom:1px solid var(--border);';
    row.innerHTML=`<span style="font-weight:700;font-size:0.88rem;">ğŸ‘¤ ${g}</span><button style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:0.9rem;">âœ•</button>`;
    row.querySelector('button').addEventListener('click',()=>{garsonlar.splice(i,1);garsonAyarListeRender();bulutKaydet();toast('Garson silindi');});
    el.appendChild(row);
  });
  if(garsonlar.length===0) el.innerHTML='<p style="color:var(--muted);font-size:0.82rem;padding:8px 0;">HenÃ¼z garson eklenmedi</p>';
}

function garsonEkleAyar(){
  const inp=document.getElementById('yeni-garson-ayar');
  const ad=inp.value.trim();
  if(!ad){toast('Garson adÄ± girin!');return;}
  if(garsonlar.includes(ad)){toast('Bu garson zaten var!');return;}
  garsonlar.push(ad); inp.value=''; garsonAyarListeRender(); bulutKaydet(); toast('âœ“ Garson eklendi: '+ad);
}

async function kafeAdiniGuncelle(){
  const yeni=document.getElementById('yeni-kafe-adi').value.trim();
  if(!yeni){toast('Kafe adÄ± girin!');return;}
  kafeAdi=yeni;
  document.getElementById('header-kafe-adi').textContent=kafeAdi;
  document.getElementById('ayar-kafe-adi').textContent=kafeAdi;
  await sb.from('kafeler').update({kafe_adi:kafeAdi}).eq('id',kafeId);
  toast('âœ“ Kafe adÄ± gÃ¼ncellendi');
}

function proPlanAc(){
  toast('Pro plan yakÄ±nda! ğŸš€ bilgi@adisyo.com');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FÄ°Å
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fisGoster(masaNo,tarih,siparisler,toplam,garsonAdi='',indirim=0,masaAd=''){
  const satirlar=siparisler.map(s=>`<div class="fis-row"><span>${s.isim} x${s.adet}</span><span>${fmt(s.fiyat*s.adet)}</span></div>`).join('');
  const el=document.getElementById('fis-yazdir-icerik');
  el.dataset.masa=masaNo; el.dataset.tarih=tarih;
  el.dataset.siparisler=JSON.stringify(siparisler); el.dataset.toplam=toplam;
  el.innerHTML=`
    <div class="fis-center" style="font-size:14px;font-weight:900;letter-spacing:2px;">${kafeAdi.toUpperCase()}</div>
    <div class="fis-center" style="font-size:10px;color:#777;">${tarih}</div>
    <div class="fis-center" style="font-weight:700;">${masaAd||'Masa '+masaNo}</div>
    ${garsonAdi?`<div class="fis-center" style="font-size:10px;color:#777;">Garson: ${garsonAdi}</div>`:''}
    <div class="fis-line"></div>
    <div class="fis-row" style="font-size:10px;color:#888;"><span>ÃœRÃœN</span><span>TUTAR</span></div>
    ${satirlar}
    <div class="fis-line"></div>
    ${indirim?`<div class="fis-row" style="font-size:10px;color:#888;"><span>Ä°ndirim</span><span>-%${indirim}</span></div>`:''}
    <div class="fis-row" style="font-size:13px;"><strong>TOPLAM</strong><strong>${fmt(toplam)}</strong></div>
    <div class="fis-line"></div>
    <div class="fis-center" style="font-size:10px;color:#777;margin-top:4px;">Tesekkur ederiz!</div>`;
  document.getElementById('fis-modal').classList.add('ac');
}

function fisYazdir(){
  if(!seciliMasa) return;
  const m=masalar[seciliMasa-1];
  if(m.siparisler.length===0){toast('Adisyon boÅŸ!');return;}
  const ham=masaToplam(m),son=ham*(1-(m.indirim||0)/100);
  fisGoster(seciliMasa,new Date().toLocaleString('tr-TR'),m.siparisler,son,m.garson||'',m.indirim||0,m.ad);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BLUETOOTH YAZICI
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function btBaglan(){
  try{
    if(!navigator.bluetooth){toast('Chrome gerekli!');return false;}
    toast('YazÄ±cÄ± aranÄ±yor...');
    const device=await navigator.bluetooth.requestDevice({acceptAllDevices:true,optionalServices:['000018f0-0000-1000-8000-00805f9b34fb','49535343-fe7d-4ae5-8fa9-9fafd205e455','e7810a71-73ae-499d-8c15-faa9aef0c3f2']});
    const server=await device.gatt.connect();
    const services=await server.getPrimaryServices();
    let c=null;
    for(const svc of services){try{const cs=await svc.getCharacteristics();for(const ch of cs){if(ch.properties.write||ch.properties.writeWithoutResponse){c=ch;break;}}if(c) break;}catch(e){}}
    if(!c){toast('YazÄ±cÄ± karakteristiÄŸi bulunamadÄ±!');return false;}
    btYazici=c; toast('âœ“ YazÄ±cÄ± baÄŸlandÄ±: '+device.name); return true;
  }catch(e){if(e.name!=='NotFoundError') toast('BT hatasÄ±: '+e.message);return false;}
}

async function yazdir(){
  const el=document.getElementById('fis-yazdir-icerik');
  const masaNo=el.dataset.masa,tarih=el.dataset.tarih;
  const siparisler=JSON.parse(el.dataset.siparisler||'[]');
  const toplam=parseFloat(el.dataset.toplam||'0');
  if(!btYazici){const b=await btBaglan();if(!b) return;}
  try{
    const satir=(sol,sag,g=32)=>sol+' '.repeat(Math.max(1,g-sol.length-sag.length))+sag+'\n';
    const cizgi='-'.repeat(32)+'\n';
    const trMap={'Ã§':135,'ÅŸ':159,'Ä±':141,'ÄŸ':168,'Ã¼':129,'Ã¶':148,'Ã‡':128,'Å':158,'Ä°':152,'Ä':167,'Ãœ':154,'Ã–':153};
    const trCevir=s=>[...s].map(c=>trMap[c]||c.charCodeAt(0)).filter(c=>c<256);
    let bytes=[];
    const ekle=s=>{bytes.push(...trCevir(s));};
    bytes.push(0x1b,0x40);
    bytes.push(0x1b,0x61,0x01);bytes.push(0x1b,0x21,0x10);ekle(kafeAdi.toUpperCase()+'\n');bytes.push(0x1b,0x21,0x00);
    ekle(tarih+'\n');bytes.push(0x1b,0x61,0x00);ekle(cizgi);
    siparisler.forEach(s=>ekle(satir((s.isim+' x'+s.adet).substring(0,22),(s.fiyat*s.adet).toFixed(2)+' TL')));
    ekle(cizgi);bytes.push(0x1b,0x21,0x10);ekle(satir('TOPLAM',toplam.toFixed(2)+' TL'));bytes.push(0x1b,0x21,0x00);
    ekle(cizgi);bytes.push(0x1b,0x61,0x01);ekle('Tesekkur ederiz!\n\n\n');
    bytes.push(0x1d,0x56,0x42,0x03);
    const data=new Uint8Array(bytes);
    for(let i=0;i<data.length;i+=100){
      const p=data.slice(i,i+100);
      if(btYazici.properties.writeWithoutResponse) await btYazici.writeValueWithoutResponse(p);
      else await btYazici.writeValueWithResponse(p);
      await new Promise(r=>setTimeout(r,30));
    }
    toast('âœ“ FiÅŸ gÃ¶nderildi!');
  }catch(e){btYazici=null;toast('Yazma hatasÄ±, tekrar baÄŸlanÄ±n');}
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODAL & UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function modalAc(id){document.getElementById(id).classList.add('ac');}
function modalKapat(id){document.getElementById(id).classList.remove('ac');}
document.querySelectorAll('.modal-overlay').forEach(el=>{el.addEventListener('click',e=>{if(e.target===el) el.classList.remove('ac');});});

function fmt(n){return n.toFixed(2).replace('.',',')+' â‚º';}
let _tt;
function toast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('goster');clearTimeout(_tt);_tt=setTimeout(()=>el.classList.remove('goster'),2800);}

// Enter tuÅŸu
document.getElementById('not-input').addEventListener('keydown',e=>{if(e.key==='Enter') document.getElementById('not-modal-kaydet').click();});
document.getElementById('giris-sifre').addEventListener('keydown',e=>{if(e.key==='Enter') girisYap();});
document.getElementById('kayit-sifre').addEventListener('keydown',e=>{if(e.key==='Enter') kayitOl();});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BAÅLAT â€” oturum kontrolÃ¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
sb.auth.getSession().then(({data:{session}})=>{
  if(session) uygulamaBaslat(session.user);
});
</script>
</body>
</html>
